<?xml version="1.0"?>
<!-- vim: set expandtab sts=1 ts=1 sw=1 : -->
<system>
 <config>
  <boolean name="xhcidbg_enabled" value="true"/>
  <boolean name="dbgserver_serial_enabled" value="true"/>
  <boolean name="dbgserver_sink_pcspkr" value="false"/>
  <boolean name="dbgserver_sink_shmem" value="false"/>
  <boolean name="pciconf_emulation_enabled" value="false"/>
  <string name="logchannel_size" value="16#0002_0000#"/>
 </config>

 <expressions>
  <expression name="dbgserver_sink_serial">
   <and>
    <variable name="dbgserver_serial_enabled"/>
    <variable name="serial_supported"/>
   </and>
  </expression>
  <expression name="dbgserver_sink_xhcidbg">
   <and>
    <variable name="xhcidbg_enabled"/>
    <variable name="xhcidbg_supported"/>
   </and>
  </expression>
 </expressions>

 <memory>
  <memory name="crash_audit" physicalAddress="16#0001_00a1_1000#" size="16#1000#" caching="UC" type="subject_crash_audit"/>
  <memory name="rust_example_stack" size="16#0020_0000#" caching="WB" type="subject"/>
  <memory name="control_time" size="16#1000#" caching="WB">
   <fill pattern="16#ff#"/>
   <hash value="none"/>
  </memory>
  <memory name="status_time" size="16#1000#" caching="WB">
   <hash value="none"/>
  </memory>
 </memory>

 <events>
  <event name="system_panic" mode="kernel"/>
  <event name="system_poweroff" mode="kernel"/>
  <event name="system_reboot" mode="kernel"/>
  <event name="subject_yield" mode="kernel"/>
  <event name="subject_sleep" mode="kernel"/>
 </events>

 <channels>
  <channel name="debuglog_rust" size="$logchannel_size"/>
  <channel name="time_info" size="16#1000#"/>

  <!-- for the time subject -->
  <channel name="debuglog_subject4" size="$logchannel_size"/>
 </channels>

 <components>
  <component name="rust_example" profile="native">
   <depends>
    <library ref="libmudebuglog"/>
    <library ref="libmutime"/>
   </depends>
    <provides>
     <memory executable="true" logical="blob" size="16#0013_0000#" type="subject_binary" virtualAddress="16#0020_0000#" writable="true">
      <file filename="rust_example" offset="none"/>
     </memory>
    </provides>
   </component>
  </components>

  <subjects>
   <include href="subject_time.xml"/>
   <subject name="rust_example">
    <vcpu>
     <vmx>
      <controls>
       <proc>
        <!-- VM-Exit on HLT instruction -->
        <HLTExiting>1</HLTExiting>
        <!-- VM-Exit on PAUSE instruction -->
        <PAUSEExiting>1</PAUSEExiting>
       </proc>
      </controls>
      <masks>
       <cr4>
        <OSSupportFXSAVE>0</OSSupportFXSAVE>
        <XSAVEEnable>0</XSAVEEnable>
       </cr4>
      </masks>
     </vmx>
     <msrs>
      <!-- IA32_GS_BASE -->
      <msr start="16#c000_0101#" end="16#c000_0101#" mode="rw"/>
     </msrs>
     <registers>
      <gpr>
       <rip>16#0020_0000#</rip>  <!-- __start64 -->
       <rsp>16#0080_0000#</rsp>
      </gpr>
     </registers>
    </vcpu>
    <memory>
     <memory executable="false" logical="ram" physical="rust_example_stack" virtualAddress="16#0060_0000#" writable="true"/>
    </memory>
    <events>
     <source>
      <group name="vmx_exit">
       <default physical="system_panic">
        <system_panic/>
       </default>
       <event id="12" logical="yield" physical="subject_yield">
        <subject_yield/>
       </event>
       <event id="13" logical="sleep" physical="subject_sleep">
        <subject_sleep/>
       </event>
      </group>
     </source>
    </events>
    <component ref="rust_example">
    <map logical="debuglog" physical="debuglog_rust" />
    <map logical="time_info" physical="time_info"/>
   </component>
  </subject>

  <subject name="dbgserver">
   <events>
    <source>
     <group name="vmx_exit">
      <default physical="system_panic">
       <system_panic/>
      </default>
     </group>
    </source>
   </events>
   <component ref="dbgserver">
    <map logical="log_channel1" physical="debuglog_rust"/>
    <map logical="log_channel2" physical="debuglog_subject4"/>
    <include href="subject_dbgserver_common.xml"/>
   </component>
  </subject>
 </subjects>

 <scheduling tickRate="1000">
  <partitions>
   <partition name="rust_partition">
    <group>
     <subject name="rust_example"/>
    </group>
   </partition>
   <partition name="time_partition">
    <group>
     <subject name="time"/>
    </group>
   </partition>
   <partition name="dbgserver">
    <group>
     <subject name="dbgserver"/>
    </group>
   </partition>
  </partitions>
  <majorFrame>
   <cpu id="0">
    <minorFrame partition="rust_partition" ticks="2"/>
    <minorFrame partition="time_partition" ticks="2"/>
    <minorFrame partition="rust_partition" ticks="2"/>
    <minorFrame partition="rust_partition" ticks="2"/>
    <minorFrame partition="rust_partition" ticks="2"/>
   </cpu>
   <cpu id="1">
    <minorFrame partition="dbgserver" ticks="4"/>
    <minorFrame partition="dbgserver" ticks="6"/>
   </cpu>
  </majorFrame>
 </scheduling>
</system>
