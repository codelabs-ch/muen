== MirageOS Unikernels

MirageOS unikernels are written in OCaml and can be run directly on top of Muen
via the https://github.com/solo5/solo5/[Solo5] platform. Support for Muen was
merged into Solo5 with https://github.com/Solo5/solo5/pull/190[pull-request
#190] and is part of the official Mirage release since version 3.5.0. The port
includes an implementation of `muennet`, thus networking is supported.

image:https-mirageos-muen.jpg[MirageOS on Muen, width=75%]

=== Muen Version
The instructions in this article have been tested with Muen revision
`f92e6cf0fddc`.

=== Unikernel Build
MirageOS heavily depends on the OCaml Package Manager
(http://opam.ocaml.org/[OPAM]) as its build system. Follow the installation
instructions https://mirage.io/wiki/install[here] to setup OPAM on your system
if you intend to compile the examples in this article manually.

==== Bob & Docker
Muen system images are built using the Bob build tool. We also provide a
ready-made Docker image containing all required software to build MirageOS
unikernels. See the link:./index.html#building-muen[Building Muen] section on
how to install bob and setup the Muen recipes.

For building MirageOS unikernels, fetch the muen-mirageos Docker image like so:

  $ docker pull ghcr.io/codelabs-ch/muen-mirageos

This container is only used for building unikernels and it is explicitly stated
in this article when commands should be executed inside the `muen-mirageos`
container.

=== Running Unikernels
Solo5 comes bundled with simple test cases, most of which can be executed on
Muen in QEMU/KVM. For convenience, there is a bob recipe and CI plan to build
and execute the "Hello World" unikernel:

  $ bob dev x86-qemu-solo5-test-debug
  $ ci/run.sh -a output -r x86-qemu-solo5-test-debug

Inspect the `vm/serial.out` file in the `output` directory to see the log
messages of the solo5 test unikernel:

```
Solo5: Console: Muen Channel @ 0xffff00000, size 0x20000, epoch 0x125e490ca
            |      ___|
  __|  _ \  |  _ \ __ \
\__ \ (   | | (   |  ) |
____/\___/ _|\___/____/
Solo5: Bindings version v0.10.0-5-gdabc69f
Solo5: Memory map: 514 MB addressable:
Solo5:   reserved @ (0x0 - 0x1fffff)
Solo5:       text @ (0x200000 - 0x204fff)
Solo5:     rodata @ (0x205000 - 0x206fff)
Solo5:       data @ (0x207000 - 0x20cfff)
Solo5:       heap >= 0x20d000 < stack < 0x2020d000
Solo5: Clock source: Muen PV clock, TSC frequency 2111994000 Hz

**** Solo5 standalone test_hello ****

Hello, World
Command line is: 'Hi!'
Solo5: solo5_exit(0) called
Solo5: Halted
```

The following bob recipes are of interest to enable Solo5/MirageOS unikernels
on Muen:

- `classes/solo5.yaml`
- `recpipes/devel/solo5.yaml`

Using the `solo5` class, other unikernels can be enabled to run on Muen/Solo5.
See the link:#serving-static-website[Serving Static Website] section below on
how to run an externally built unikernel using the provided Docker image.

=== Serving Static Website
The `mirage-skeleton` https://github.com/mirage/mirage-skeleton/[repository]
contains example unikernels. One of these examples serves a
https://www.codelabs.ch/img/C6wSmDiWoAEQFvx.jpg[static website]. The repository
comes checked out in the `muen-mirageos` Docker container in the correct
version to match mirage. The image also provides a pre-built
`static_website_tls` unikernel corresponding to the configuration described in
this article. Issue the following commands to use it for a quick test:

  $ docker create --name tmp ghcr.io/codelabs-ch/muen-mirageos
  $ docker cp tmp:/home/opam/https.muen ./https.muen

If you want to customize the unikernel see below, otherwise skip to section
link:#build-system-image[Build System Image].

==== Customize
The content that will be served can be found in the `htdocs` directory of the
`static_website_tls` application. You can replace it with something more
interesting, e.g. an article about your successful adventures with MirageOS and
Muen. Then don't forget to rebuild the unikernel (see below).

Which IP address the unikernel is supposed to use is configured via the
`--ipv4*` options that can either be passed as unikernel configure parameters
or using the `--bootparams` parameter of the `solo5-muen-gencspec.py` script.

To serve the website from 192.168.254.10, build the `static_website_tls`
unikernel by issuing the following commands in the `muen-mirageos` container:

  $ docker run -it -v ${PWD}:/mnt ghcr.io/codelabs-ch/muen-mirageos

  $ cd mirage-skeleton/applications/static_website_tls
  $ mirage configure -t muen --ipv4=192.168.254.10/24 --ipv4-gateway=192.168.254.1
  $ make

If all goes well an unikernel image called `https.muen` should be present in
the `dist` directory. Copy this to your host and exit the container:

  $ cp dist/https.muen /mnt/
  $ exit

==== Build System Image
Build the unikernel with the following bob command. Set the `UNIKERNEL_FILE`
variable so it points to the `https.muen` unikernel binary:

  $ bob dev x86-qemu-solo5-debug -DUNIKERNEL_FILE=${PWD}/https.muen

The unikernel serves the website via https on port 4433. Since we are using
QEMU's host forwarding to expose networking of the emulated system, we must
forward this port by setting the `QEMU_NETDEV_EXTRA_OPTS` environment variable:

  $ export QEMU_NETDEV_EXTRA_OPTS="hostfwd=tcp::4433-192.168.254.10:4433"

NOTE: Make sure to use the same IP address that you specified in the mirage
configure step if you customized the unikernel.

Time to run the system using QEMU:

  $ contrib/runQemu.py -q x86-qemu-solo5-debug

Finally, you can point your browser to `https://localhost:4433/` and after
accepting the certificate warnings you should see the static website served by
MirageOS. Congratulations, you have just successfully served yourself a website
via a MirageOS unikernel running on Muen!

NOTE: When deploying the system to hardware you must direct your browser to the
IP address, which was used to configure the unikernel, e.g.
`https://192.168.254.10:4433/`.
